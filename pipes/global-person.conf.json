{
  "_id": "global-person",
  "type": "pipe",
  "source": {
    "type": "dataset",
    "dataset": "merged-person"
  },
  "transform": {
    "type": "dtl",
    "rules": {
      "default": [
        ["copy", "*"],
        ["add", "firstname",
          ["coalesce",
            ["list", "_S.hr-person:GivenName", "_S.crm-person:FirstName", "_S.erp-person:GivenName"]
          ]
        ],
        ["add", "middle-initial",
          ["coalesce",
            ["list", "_S.hr-person:MiddleInitial", "_S.crm-person:MiddleInitial", "_S.erp-person:MiddleInitial"]
          ]
        ],
        ["add", "lastname",
          ["coalesce",
            ["list", "_S.hr-person:Surname", "_S.crm-person:LastName", "_S.erp-person:Surname"]
          ]
        ],
        ["add", "fullname",
          ["join", " ",
            ["list", "_T.global-person:firstname",
              ["if",
                ["is-not-null", "_T.global-person:middle-initial"],
                ["concat", "_T.global-person:middle-initial", "."]
              ], "_T.global-person:lastname"]
          ]
        ],
        ["add", "address",
          ["coalesce",
            ["list", "_S.crm-person:Address", "_S.hr-person:StreetAddress", "_S.erp-person:StreetAddress"]
          ]
        ],
        ["add", "zipcode",
          ["coalesce",
            ["list", "_S.hr-person:ZipCode", "_S.crm-person:PostalCode", "_S.erp-person:ZipCode"]
          ]
        ],
        ["add", "city",
          ["first",
            ["hops", {
              "datasets": ["global-location gl"],
              "where": [
                ["eq",
                  ["coalesce",
                    ["list", "_S.hr-person:ZipCode", "_S.crm-person:PostalCode", "_S.erp-person:ZipCode"]
                  ], "gl.udir-postalcode:postalcode"]
              ],
              "return": "gl.city"
            }]
          ]
        ],
        ["add", "country",
          ["coalesce",
            ["list", "_S.hr-person:Country", "_S.erp-person:Country"]
          ]
        ],
        ["add", "gender",
          ["coalesce",
            ["list", "_S.hr-person:Gender", "_S.crm-person:Gender", "_S.erp-person:Gender"]
          ]
        ],
        ["add", "emailll",
          ["coalesce",
            ["list", "_S.mailerlite-person:email", "_S.crm-person.EmailAddress", "_S.salesforce-userprofile:EmailAddress", "_S.hr-person:EmailAddress"]
          ]
        ]
      ]
    }
  },
  "metadata": {
    "global": true
  }
}
